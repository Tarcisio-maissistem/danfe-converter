<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiqueta 100x150mm - Ajuste Seguro</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; }
        body { font-family: Arial, sans-serif; background: #eee; display: flex; gap: 20px; justify-content: center; padding: 20px; }
        
        /* EDITOR */
        .editor { background: white; padding: 20px; width: 380px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); height: fit-content; }
        .editor h2 { color: var(--primary); font-size: 16px; border-bottom: 2px solid var(--accent); padding-bottom: 5px; margin-top: 0; }
        .group { margin-bottom: 8px; }
        label { font-size: 11px; font-weight: bold; display: block; margin-bottom: 2px; }
        input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .row { display: flex; gap: 5px; } .col { flex: 1; }
        button { width: 100%; padding: 10px; background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        button:hover { background: #1f3a52; }
        .btn-save { background: #27ae60; }

        /* PREVIEW / IMPRESSÃO */
        .preview { display: flex; justify-content: center; }
        .sheet {
            width: 100mm;
            height: 148mm; /* Levemente menor que 150mm para evitar quebra de página */
            background: white;
            border: 1px solid #999;
            box-sizing: border-box;
            padding: 3mm 5mm; /* Margens internas seguras */
            display: flex;
            flex-direction: column;
            color: black;
            overflow: hidden; /* Impede que corte estoure */
            position: relative;
        }

        /* ÁREA DESTINATÁRIO */
        .header { font-size: 8pt; font-weight: bold; border-bottom: 1px solid black; padding-bottom: 2px; margin-bottom: 5px; text-transform: uppercase; }
        
        .dest-nome { 
            font-size: 18pt; /* Grande, mas seguro */
            font-weight: 900; 
            line-height: 1.1; 
            margin-bottom: 5px; 
            display: block; 
            text-transform: uppercase; 
            word-wrap: break-word;
            max-height: 75px; /* Limite para não empurrar o resto */
            overflow: hidden;
        }
        
        .dest-doc { font-size: 9pt; margin-bottom: 8px; display: block; }
        
        .dest-end { 
            font-size: 13pt; 
            line-height: 1.25; 
            margin-bottom: 5px; 
            font-weight: 600;
            flex-grow: 1; /* Ocupa espaço disponível */
        }

        .cep-line { font-size: 12pt; font-weight: bold; margin-top: 5px; display: block; }

        /* ÁREA REMETENTE */
        .divider { border-top: 2px solid black; margin: 5px 0; }
        .rem-box { font-size: 9pt; line-height: 1.2; }
        .rem-title { font-weight: bold; font-size: 7pt; text-transform: uppercase; }

        @media print {
            body { background: none; margin: 0; padding: 0; display: block; }
            .editor { display: none; }
            .sheet { border: none; width: 100mm; height: 149mm; page-break-after: always; }
            @page { size: 100mm 150mm; margin: 0; } /* Força o tamanho no navegador */
        }
    </style>
</head>
<body>

    <div class="editor">
        <h2>1. Destinatário</h2>
        <div class="group"><label>CPF/CNPJ (Busca Automática)</label><input type="text" id="d_doc" oninput="mask(this); checkCNPJ(this, 'd')" maxlength="18"></div>
        <div class="group"><label>CEP (Busca Endereço)</label><input type="text" id="d_cep" oninput="maskCEP(this); checkCEP(this)" maxlength="9"></div>
        <div class="group"><label>Nome Completo</label><input type="text" id="d_nome" oninput="upd()"></div>
        
        <div class="row">
            <div class="col" style="flex:3"><label>Rua</label><input type="text" id="d_rua" oninput="upd()"></div>
            <div class="col"><label>Nº</label><input type="text" id="d_num" oninput="upd()"></div>
        </div>
        <div class="row">
            <div class="col"><label>Bairro</label><input type="text" id="d_bairro" oninput="upd()"></div>
            <div class="col"><label>Comp.</label><input type="text" id="d_comp" oninput="upd()"></div>
        </div>
        <div class="row">
            <div class="col"><label>Cidade</label><input type="text" id="d_cidade" oninput="upd()"></div>
            <div class="col"><label>UF</label><input type="text" id="d_uf" oninput="upd()"></div>
        </div>

        <h2 style="margin-top:15px">2. Remetente</h2>
        <div class="group"><label>CPF/CNPJ (Busca Automática)</label><input type="text" id="r_doc" oninput="mask(this); checkCNPJ(this, 'r')" maxlength="18"></div>
        <input type="text" id="r_nome" placeholder="Nome" oninput="upd()">
        <input type="text" id="r_end" placeholder="Endereço Completo" oninput="upd()">
        <div class="row">
            <div class="col"><label>Cidade/UF</label><input type="text" id="r_cidade" oninput="upd()"></div>
            <div class="col"><label>CEP</label><input type="text" id="r_cep" oninput="maskCEP(this); upd()"></div>
        </div>

        <button class="btn-save" onclick="saveRem()">Salvar Dados Remetente</button>
        <button onclick="window.print()">IMPRIMIR</button>
    </div>

    <div class="preview">
        <div class="sheet">
            <div class="header">DESTINATÁRIO</div>
            
            <span id="v_d_nome" class="dest-nome">NOME DO CLIENTE</span>
            <span id="v_d_doc" class="dest-doc"></span>
            
            <div class="dest-end">
                <span id="v_d_rua">Rua Exemplo</span>, <span id="v_d_num">000</span> <span id="v_d_comp"></span><br>
                <span id="v_d_bairro">Bairro</span><br>
                <span id="v_d_cidade">Cidade</span> - <span id="v_d_uf">UF</span>
                <span class="cep-line">CEP: <span id="v_d_cep">00000-000</span></span>
            </div>

            <div class="divider"></div>
            
            <div class="rem-box">
                <span class="rem-title">Remetente:</span><br>
                <b id="v_r_nome">Sua Loja</b><br>
                <span id="v_r_end">Seu Endereço, 000</span><br>
                <span id="v_r_cidade">Cidade - UF</span><br>
                <span id="v_r_doc"></span> CEP: <span id="v_r_cep">00000-000</span>
            </div>
        </div>
    </div>

    <script>
        function upd(){
            ['d','r'].forEach(t => {
                document.getElementById('v_'+t+'_nome').innerText = document.getElementById(t+'_nome').value || (t=='d'?"NOME DO CLIENTE":"LOJA");
                let doc = document.getElementById(t+'_doc').value;
                document.getElementById('v_'+t+'_doc').innerText = doc ? (doc.length>14?"CNPJ: ":"CPF: ")+doc : "";
            });
            document.getElementById('v_d_rua').innerText = document.getElementById('d_rua').value;
            document.getElementById('v_d_num').innerText = document.getElementById('d_num').value;
            let comp = document.getElementById('d_comp').value;
            document.getElementById('v_d_comp').innerText = comp ? "- "+comp : "";
            document.getElementById('v_d_bairro').innerText = document.getElementById('d_bairro').value;
            document.getElementById('v_d_cidade').innerText = document.getElementById('d_cidade').value;
            document.getElementById('v_d_uf').innerText = document.getElementById('d_uf').value;
            document.getElementById('v_d_cep').innerText = document.getElementById('d_cep').value;

            document.getElementById('v_r_end').innerText = document.getElementById('r_end').value;
            document.getElementById('v_r_cidade').innerText = document.getElementById('r_cidade').value;
            document.getElementById('v_r_cep').innerText = document.getElementById('r_cep').value;
        }

        function mask(o){ o.value=o.value.replace(/\D/g,"").replace(/^(\d{2})(\d)/,"$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3").replace(/\.(\d{3})(\d)/,".$1/$2").replace(/(\d{4})(\d)/,"$1-$2").slice(0,18); upd();}
        function maskCEP(o){ o.value=o.value.replace(/\D/g,"").replace(/^(\d{5})(\d)/,"$1-$2").slice(0,9); upd();}

        function checkCNPJ(o,t){
            let v = o.value.replace(/\D/g,"");
            if(v.length===14){
                document.getElementById(t+'_nome').value = "Buscando...";
                fetch(`https://brasilapi.com.br/api/cnpj/v1/${v}`).then(r=>r.json()).then(d=>{
                    document.getElementById(t+'_nome').value=d.razao_social;
                    if(t=='d'){
                        document.getElementById('d_rua').value=d.logradouro; document.getElementById('d_num').value=d.numero;
                        document.getElementById('d_bairro').value=d.bairro; document.getElementById('d_cidade').value=d.municipio;
                        document.getElementById('d_uf').value=d.uf; document.getElementById('d_cep').value=d.cep;
                    }else{
                        document.getElementById('r_end').value=`${d.logradouro}, ${d.numero}, ${d.bairro}`;
                        document.getElementById('r_cidade').value=`${d.municipio} - ${d.uf}`; document.getElementById('r_cep').value=d.cep;
                    }
                    maskCEP(document.getElementById(t+'_cep')); upd();
                }).catch(()=>{document.getElementById(t+'_nome').value=""; alert("CNPJ não encontrado")});
            }
        }

        function checkCEP(o){
            let v = o.value.replace(/\D/g,"");
            if(v.length===8){
                document.getElementById('d_rua').value="...";
                fetch(`https://viacep.com.br/ws/${v}/json/`).then(r=>r.json()).then(d=>{
                    if(!d.erro){
                        document.getElementById('d_rua').value=d.logradouro; document.getElementById('d_bairro').value=d.bairro;
                        document.getElementById('d_cidade').value=d.localidade; document.getElementById('d_uf').value=d.uf;
                        document.getElementById('d_num').focus(); upd();
                    }
                });
            }
        }

        function saveRem(){
            const d = {doc:document.getElementById('r_doc').value, nome:document.getElementById('r_nome').value, end:document.getElementById('r_end').value, cid:document.getElementById('r_cidade').value, cep:document.getElementById('r_cep').value};
            localStorage.setItem('sys_remetente', JSON.stringify(d)); alert("Salvo!");
        }

        window.onload=()=>{
            const s = JSON.parse(localStorage.getItem('sys_remetente'));
            if(s){ document.getElementById('r_doc').value=s.doc; document.getElementById('r_nome').value=s.nome; document.getElementById('r_end').value=s.end; document.getElementById('r_cidade').value=s.cid; document.getElementById('r_cep').value=s.cep; upd(); }
        }
    </script>
</body>
</html>