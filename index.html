<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declaração de Conteúdo - Auto Preenchimento</title>
    <style>
        :root {
            --primary-color: #f1c40f; /* Amarelo Correios */
            --secondary-color: #00416b; /* Azul Correios */
            --border-color: #000;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        /* --- EDITOR (Lateral Esquerda) --- */
        .editor-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 360px;
            height: fit-content;
        }

        h2 { color: var(--secondary-color); font-size: 18px; margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }
        
        .section-title { font-size: 12px; font-weight: bold; color: #666; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; border-top: 1px dashed #ccc; padding-top: 10px; }
        
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 8px; font-size: 13px; }
        input:focus { border-color: var(--secondary-color); outline: none; }
        
        .row { display: flex; gap: 5px; }
        .col { flex: 1; }

        button {
            width: 100%; padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; margin-top: 10px;
            transition: 0.2s;
        }
        .btn-add { background-color: var(--secondary-color); color: white; }
        .btn-add:hover { background-color: #003355; }
        .btn-print { background-color: var(--primary-color); color: var(--secondary-color); margin-top: 20px; font-size: 16px; }
        .btn-print:hover { filter: brightness(0.9); }

        /* --- VISUALIZAÇÃO A4 (Direita) --- */
        .page-sheet {
            width: 210mm; /* A4 */
            min-height: 297mm;
            background: white;
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            color: black;
        }

        /* Estrutura visual da Declaração */
        .doc-title {
            text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 10px; text-transform: uppercase;
        }

        .box-section {
            border: 1px solid black;
            margin-bottom: -1px;
            padding: 5px;
            font-size: 10pt;
        }

        .box-header {
            background-color: #eee; font-weight: bold; text-transform: uppercase; font-size: 9pt;
            padding: 2px 5px; border-bottom: 1px solid black; margin: -5px -5px 5px -5px;
        }

        .data-row { display: flex; gap: 10px; margin-bottom: 3px; }
        .data-field { flex: 1; }
        .label { font-weight: bold; font-size: 8pt; margin-right: 3px; }
        .value { font-size: 10pt; text-transform: uppercase; }

        /* Tabela de Itens */
        table.items-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 10px; }
        table.items-table th, table.items-table td { border: 1px solid black; padding: 4px; text-align: center; }
        table.items-table th { background-color: #eee; }
        .text-left { text-align: left !important; }

        /* Jurídico */
        .legal-text { font-size: 8pt; text-align: justify; margin-top: 10px; line-height: 1.2; }
        .signature-area { margin-top: 30px; text-align: center; }
        .signature-line { border-top: 1px solid black; width: 60%; margin: 30px auto 5px auto; }
        .footer-warning { font-size: 7pt; margin-top: 15px; font-style: italic; }

        /* --- IMPRESSÃO --- */
        @media print {
            body { background: none; margin: 0; padding: 0; }
            .editor-container { display: none; }
            .page-sheet { box-shadow: none; margin: 0; width: 100%; page-break-after: always; }
        }
    </style>
</head>
<body>

    <div class="editor-container">
        <h2>Editor Declaração</h2>
        
        <div class="section-title">1. Destinatário (Quem recebe)</div>
        <div class="row">
            <div class="col">
                <input type="text" id="dest_doc" placeholder="CPF ou CNPJ (Busca Auto)" oninput="handleDoc(this, 'dest')" maxlength="18" style="font-weight:bold; border-color:#d35400;">
            </div>
        </div>
        <div class="row">
            <div class="col" style="flex:1">
                <input type="text" id="dest_cep" placeholder="CEP (Busca Auto)" oninput="handleCEP(this, 'dest')" maxlength="9">
            </div>
        </div>
        <input type="text" id="dest_nome" placeholder="Nome Completo" oninput="updateView()">
        <input type="text" id="dest_end" placeholder="Endereço, Nº, Bairro" oninput="updateView()">
        <div class="row">
            <div class="col"><input type="text" id="dest_cidade" placeholder="Cidade" oninput="updateView()"></div>
            <div class="col" style="flex: 0.4"><input type="text" id="dest_uf" placeholder="UF" oninput="updateView()"></div>
        </div>

        <div class="section-title">2. Itens do Pacote</div>
        <input type="text" id="item_desc" placeholder="Descrição (Ex: Roupas)">
        <div class="row">
            <div class="col"><input type="number" id="item_qtd" placeholder="Qtd" value="1"></div>
            <div class="col"><input type="number" id="item_val" placeholder="Valor Unit. (R$)" step="0.01"></div>
        </div>
        <button class="btn-add" onclick="addItem()">+ Adicionar Item</button>

        <div class="section-title">3. Remetente (Você)</div>
        <input type="text" id="rem_doc" placeholder="Seu CPF/CNPJ" oninput="handleDoc(this, 'rem')" maxlength="18">
        <input type="text" id="rem_nome" placeholder="Seu Nome" oninput="updateView()">
        <input type="text" id="rem_end" placeholder="Seu Endereço" oninput="updateView()">
        <div class="row">
            <div class="col"><input type="text" id="rem_cidade" placeholder="Cidade" oninput="updateView()"></div>
            <div class="col" style="flex: 0.4"><input type="text" id="rem_uf" placeholder="UF" oninput="updateView()"></div>
            <div class="col" style="flex: 0.6"><input type="text" id="rem_cep" placeholder="CEP" oninput="updateView()"></div>
        </div>

        <button class="btn-print" onclick="window.print()">IMPRIMIR AGORA</button>
    </div>

    <div class="page-sheet">
        <div class="doc-title">DECLARAÇÃO DE CONTEÚDO</div>

        <div class="box-section">
            <div class="box-header">REMETENTE [cite: 5]</div>
            <div class="data-row">
                <div class="data-field"><span class="label">NOME:</span> <span id="view_rem_nome" class="value"></span></div>
                <div class="data-field" style="flex:0.4"><span class="label">CPF/CNPJ:</span> <span id="view_rem_doc" class="value"></span></div>
            </div>
            <div class="data-row">
                <div class="data-field"><span class="label">ENDEREÇO:</span> <span id="view_rem_end" class="value"></span></div>
            </div>
            <div class="data-row">
                <div class="data-field"><span class="label">CIDADE:</span> <span id="view_rem_cidade" class="value"></span></div>
                <div class="data-field" style="flex:0.2"><span class="label">CEP:</span> <span id="view_rem_cep" class="value"></span></div>
                <div class="data-field" style="flex:0.1"><span class="label">UF:</span> <span id="view_rem_uf" class="value"></span></div>
            </div>
        </div>

        <div class="box-section" style="border-top:none;">
            <div class="box-header">DESTINATÁRIO [cite: 6]</div>
            <div class="data-row">
                <div class="data-field"><span class="label">NOME:</span> <span id="view_dest_nome" class="value"></span></div>
                <div class="data-field" style="flex:0.4"><span class="label">CPF/CNPJ:</span> <span id="view_dest_doc" class="value"></span></div>
            </div>
            <div class="data-row">
                <div class="data-field"><span class="label">ENDEREÇO:</span> <span id="view_dest_end" class="value"></span></div>
            </div>
            <div class="data-row">
                <div class="data-field"><span class="label">CIDADE:</span> <span id="view_dest_cidade" class="value"></span></div>
                <div class="data-field" style="flex:0.2"><span class="label">CEP:</span> <span id="view_dest_cep" class="value"></span></div>
                <div class="data-field" style="flex:0.1"><span class="label">UF:</span> <span id="view_dest_uf" class="value"></span></div>
            </div>
        </div>

        <div class="box-section" style="border-top:none; min-height: 250px;">
            <div class="box-header">IDENTIFICAÇÃO DOS BENS [cite: 13]</div>
            
            <table class="items-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">ITEM</th>
                        <th class="text-left">CONTEÚDO</th>
                        <th style="width: 80px;">QUANT.</th>
                        <th style="width: 100px;">VALOR (R$)</th>
                    </tr>
                </thead>
                <tbody id="items_body">
                    </tbody>
                <tfoot>
                    <tr style="font-weight:bold; background:#eee;">
                        <td colspan="2" style="text-align:right; padding-right:10px;">TOTAIS</td>
                        <td id="total_qtd">0</td>
                        <td id="total_val">R$ 0,00</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="text-align:right; padding: 5px;">PESO TOTAL (kg): <span style="border-bottom:1px solid #000; padding:0 10px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="box-section" style="border-top:none;">
            <div class="box-header">DECLARAÇÃO [cite: 14]</div>
            <div class="legal-text">
                Declaro que não me enquadro no conceito de contribuinte previsto no art. 4º da Lei Complementar nº 87/1996, uma vez que não realizo, com habitualidade ou em volume que caracterize intuito comercial, operações de circulação de mercadoria, ainda que se iniciem no exterior, ou estou dispensado da emissão da nota fiscal por força da legislação tributária vigente, responsabilizando-me, nos termos da lei e a quem de direito, por informações inverídicas. [cite: 15, 16]<br><br>
                
                Declaro que não envio objeto que ponha em risco o transporte aéreo, nem objeto proibido no fluxo postal, assumindo responsabilidade pela informação prestada, e ciente de que o descumprimento pode configurar crime, conforme artigo 261 do Código Penal Brasileiro. [cite: 17]<br><br>
                
                Declaro, ainda, estar ciente da lista de proibições e restrições, disponível no site dos Correios: https://www.correios.com.br/enviar/proibicoes-e-restricoes/proibicoes-e-restricoes. [cite: 18]
            </div>

            <div class="signature-area">
                <div style="margin-bottom: 20px;">
                    <span id="sig_cidade">Cidade</span> - <span id="sig_uf">UF</span>, <span id="sig_data">__/__/____</span>
                </div>
                <div class="signature-line"></div>
                Assinatura do Declarante/Remetente [cite: 21]
            </div>
        </div>

        <div class="footer-warning">
            OBSERVAÇÃO: Constitui crime contra a ordem tributária suprimir ou reduzir tributo, ou contribuição social e qualquer acessório (Lei 8.137/90 Art. 1°, V). [cite: 22, 23]
        </div>
    </div>

    <script>
        let items = [];

        // --- 1. MÁSCARA E LÓGICA DE DOCUMENTO (CPF/CNPJ) ---
        function handleDoc(input, type) {
            let v = input.value.replace(/\D/g, "");
            
            // Máscara
            if (v.length <= 11) { 
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d)/, "$1.$2");
                v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            } else { 
                v = v.replace(/^(\d{2})(\d)/, "$1.$2");
                v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
                v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
                v = v.replace(/(\d{4})(\d)/, "$1-$2");
            }
            input.value = v;
            updateView();

            // Se for CNPJ (14 dígitos limpos), busca na API
            let cleanVal = input.value.replace(/\D/g, "");
            if (cleanVal.length === 14) {
                buscarCNPJ(cleanVal, type);
            }
        }

        // --- 2. BUSCA AUTOMÁTICA DE CNPJ ---
        function buscarCNPJ(cnpj, type) {
            let fieldNome = document.getElementById(type + '_nome');
            fieldNome.value = "Buscando CNPJ...";
            
            fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`)
                .then(r => r.json())
                .then(data => {
                    // Preenche campos
                    fieldNome.value = data.razao_social;
                    document.getElementById(type + '_cidade').value = data.municipio;
                    document.getElementById(type + '_uf').value = data.uf;
                    
                    // Monta endereço completo
                    let endereco = `${data.logradouro}, ${data.numero}`;
                    if(data.complemento) endereco += ` - ${data.complemento}`;
                    endereco += ` - ${data.bairro}`;
                    document.getElementById(type + '_end').value = endereco;

                    // Formata CEP
                    let cep = data.cep.toString();
                    if(cep.length === 8) cep = cep.substring(0,5)+"-"+cep.substring(5,8);
                    document.getElementById(type + '_cep').value = cep;

                    updateView();
                })
                .catch(() => { fieldNome.value = ""; alert("CNPJ não encontrado."); });
        }

        // --- 3. BUSCA AUTOMÁTICA DE CEP ---
        function handleCEP(input, type) {
            let v = input.value.replace(/\D/g, "");
            if (v.length > 5) v = v.substring(0, 5) + "-" + v.substring(5, 8);
            input.value = v;
            updateView();

            if (input.value.replace("-", "").length === 8) {
                buscarCEP(input.value.replace("-", ""), type);
            }
        }

        function buscarCEP(cep, type) {
            document.getElementById(type + '_end').value = "Buscando...";
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(r => r.json())
                .then(data => {
                    if(!data.erro) {
                        document.getElementById(type + '_end').value = `${data.logradouro}, , ${data.bairro}`;
                        document.getElementById(type + '_cidade').value = data.localidade;
                        document.getElementById(type + '_uf').value = data.uf;
                        updateView();
                        
                        // Foca no endereço para a pessoa digitar o número
                        let endField = document.getElementById(type + '_end');
                        endField.focus();
                        // Posiciona cursor entre as vírgulas (truque simples)
                        let pos = data.logradouro.length + 2; 
                        endField.setSelectionRange(pos, pos);
                    } else {
                         document.getElementById(type + '_end').value = "";
                    }
                });
        }

        // --- 4. ATUALIZAÇÃO VISUAL ---
        function updateView() {
            // Destinatário
            document.getElementById('view_dest_nome').innerText = document.getElementById('dest_nome').value;
            document.getElementById('view_dest_doc').innerText = document.getElementById('dest_doc').value;
            document.getElementById('view_dest_end').innerText = document.getElementById('dest_end').value;
            document.getElementById('view_dest_cidade').innerText = document.getElementById('dest_cidade').value;
            document.getElementById('view_dest_uf').innerText = document.getElementById('dest_uf').value;
            document.getElementById('view_dest_cep').innerText = document.getElementById('dest_cep').value;

            // Remetente
            document.getElementById('view_rem_nome').innerText = document.getElementById('rem_nome').value;
            document.getElementById('view_rem_doc').innerText = document.getElementById('rem_doc').value;
            document.getElementById('view_rem_end').innerText = document.getElementById('rem_end').value;
            document.getElementById('view_rem_cidade').innerText = document.getElementById('rem_cidade').value;
            document.getElementById('view_rem_uf').innerText = document.getElementById('rem_uf').value;
            document.getElementById('view_rem_cep').innerText = document.getElementById('rem_cep').value;

            // Atualiza área da assinatura
            let cid = document.getElementById('rem_cidade').value || "Cidade";
            let uf = document.getElementById('rem_uf').value || "UF";
            document.getElementById('sig_cidade').innerText = cid;
            document.getElementById('sig_uf').innerText = uf;
        }

        // --- 5. ITENS DA DECLARAÇÃO ---
        function addItem() {
            let desc = document.getElementById('item_desc').value;
            let qtd = parseInt(document.getElementById('item_qtd').value) || 0;
            let val = parseFloat(document.getElementById('item_val').value) || 0;

            if(!desc || qtd <= 0) { alert("Preencha o item!"); return; }

            items.push({ desc, qtd, val });
            renderItems();
            
            document.getElementById('item_desc').value = "";
            document.getElementById('item_val').value = "";
            document.getElementById('item_desc').focus();
        }

        function renderItems() {
            const tbody = document.getElementById('items_body');
            tbody.innerHTML = "";
            let totalQ = 0, totalV = 0;

            items.forEach((item, index) => {
                totalQ += item.qtd;
                totalV += (item.val * item.qtd);
                tbody.innerHTML += `<tr>
                    <td>${index + 1}</td>
                    <td class="text-left">${item.desc} <span style="color:red;cursor:pointer;float:right" onclick="removeItem(${index})">×</span></td>
                    <td>${item.qtd}</td>
                    <td>R$ ${item.val.toFixed(2).replace('.', ',')}</td>
                </tr>`;
            });

            // Linhas vazias para preencher tabela
            for(let i=0; i < (6 - items.length); i++) {
                tbody.innerHTML += `<tr><td>&nbsp;</td><td></td><td></td><td></td></tr>`;
            }

            document.getElementById('total_qtd').innerText = totalQ;
            document.getElementById('total_val').innerText = "R$ " + totalV.toFixed(2).replace('.', ',');
        }

        function removeItem(i) { items.splice(i, 1); renderItems(); }

        // --- 6. CARREGAR DADOS SALVOS (CACHE) ---
        window.onload = function() {
            // Tenta carregar da memória da etiqueta anterior
            const dados = localStorage.getItem('etiqueta_remetente_full') || localStorage.getItem('etiqueta_remetente_v3');
            if (dados) {
                const d = JSON.parse(dados);
                document.getElementById('rem_doc').value = d.doc || "";
                document.getElementById('rem_nome').value = d.nome || "";
                
                // Endereço vem tudo junto no cache, tentamos usar, mas o usuario pode editar
                document.getElementById('rem_end').value = d.end || "";
                document.getElementById('rem_cep').value = d.cep || "";
                
                // Separa Cidade/UF se tiver traço
                if(d.cidade && d.cidade.includes("-")) {
                    let partes = d.cidade.split("-");
                    document.getElementById('rem_cidade').value = partes[0].trim();
                    document.getElementById('rem_uf').value = partes[1].trim();
                } else {
                    document.getElementById('rem_cidade').value = d.cidade || "";
                }
                updateView();
            }
            // Data atual
            document.getElementById('sig_data').innerText = new Date().toLocaleDateString('pt-BR');
        };
    </script>
</body>
</html>